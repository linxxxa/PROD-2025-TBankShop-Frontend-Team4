# GitLab CI/CD Ğ´Ğ»Ñ Ñ…Ğ°ĞºĞ°Ñ‚Ğ¾Ğ½Ğ°
# Ğ¢-Ğ‘Ğ°Ğ½Ğº Ğ¡ÑƒĞ¿ĞµÑ€Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ñ‹

variables:
  VM_HOST: "team-04-hyn9y74f.hack.prodcontest.ru"
  VM_USER: "student"
  VM_PORT: "22"
  DOMAIN: "team-04-hyn9y74f.hack.prodcontest.ru"
  SSH_KEY_FILE: "private_key.pem"
  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ñ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
  VM_INFO_URL: "https://team-04-hyn9y74f.hack.prodcontest.ru/api/info"
  VM_STATUS_URL: "https://team-04-hyn9y74f.hack.prodcontest.ru/api/status"

stages:
  - info
  - setup
  - deploy
  - verify

# ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
get_vm_info:
  stage: info
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "ğŸ“¡ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹..."
    - |
      # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğµ
      VM_INFO=$(curl -s "$VM_INFO_URL" || echo '{"status":"unavailable"}')
      echo "VM Info: $VM_INFO"
      
      # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
      VM_STATUS=$(curl -s "$VM_STATUS_URL" || echo '{"status":"unavailable"}')
      echo "VM Status: $VM_STATUS"
      
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ SSH
      if nc -z "$VM_HOST" "$VM_PORT" 2>/dev/null; then
        echo "âœ… SSH Ğ¿Ğ¾Ñ€Ñ‚ $VM_PORT Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        SSH_AVAILABLE="true"
      else
        echo "âŒ SSH Ğ¿Ğ¾Ñ€Ñ‚ $VM_PORT Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        SSH_AVAILABLE="false"
      fi
      
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ HTTP
      if curl -s -I "http://$DOMAIN" | grep -q "200\|301"; then
        echo "âœ… HTTP Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        HTTP_AVAILABLE="true"
      else
        echo "âŒ HTTP Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        HTTP_AVAILABLE="false"
      fi
      
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ HTTPS
      if curl -s -I "https://$DOMAIN" | grep -q "200"; then
        echo "âœ… HTTPS Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        HTTPS_AVAILABLE="true"
      else
        echo "âŒ HTTPS Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        HTTPS_AVAILABLE="false"
      fi
      
      # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²
      echo "SSH_AVAILABLE=$SSH_AVAILABLE" >> vm_info.env
      echo "HTTP_AVAILABLE=$HTTP_AVAILABLE" >> vm_info.env
      echo "HTTPS_AVAILABLE=$HTTPS_AVAILABLE" >> vm_info.env
  artifacts:
    reports:
      dotenv: vm_info.env
    expire_in: 1 hour
  allow_failure: true

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° SSH Ğ¸ SSL
setup_ssh_ssl:
  stage: setup
  image: alpine:latest
  dependencies:
    - get_vm_info
  before_script:
    - apk add --no-cache openssh-client curl
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/private_key.pem
    - chmod 600 ~/.ssh/private_key.pem
    - ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸ” Setting up SSH connection..."
    - echo "SSH Available: $SSH_AVAILABLE"
    - |
      if [ "$SSH_AVAILABLE" = "true" ]; then
        ssh -i ~/.ssh/private_key.pem -p $VM_PORT -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "echo 'SSH connection successful'"
        echo "âœ… SSH connection established"
      else
        echo "âŒ SSH not available, skipping connection test"
        exit 1
      fi
  artifacts:
    paths:
      - ~/.ssh/private_key.pem
    expire_in: 1 hour

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
setup_ssl:
  stage: setup
  image: alpine:latest
  script:
    - echo "ğŸ”’ Setting up SSL certificates..."
    - mkdir -p ssl
    - echo "$SSL_CERT" > ssl/cert.pem
    - echo "$SSL_CHAIN" > ssl/chain.pem
    - echo "$SSL_FULLCHAIN" > ssl/fullchain.pem
    - echo "$SSL_PRIVKEY" > ssl/privkey.pem
    - echo "âœ… SSL certificates configured"
  artifacts:
    paths:
      - ssl/
    expire_in: 1 hour

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker Ğ½Ğ° VM
install_docker:
  stage: deploy
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "ğŸ³ Installing Docker on VM..."
    - ssh -i private_key.pem -p $VM_PORT $VM_USER@$VM_HOST "
        if ! command -v docker &> /dev/null; then
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker \$USER
          echo 'Docker installed'
        else
          echo 'Docker already installed'
        fi
      "

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker Compose Ğ½Ğ° VM
install_docker_compose:
  stage: deploy
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "ğŸ³ Installing Docker Compose on VM..."
    - ssh -i private_key.pem -p $VM_PORT $VM_USER@$VM_HOST "
        if ! command -v docker-compose &> /dev/null; then
          sudo curl -L \"https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          echo 'Docker Compose installed'
        else
          echo 'Docker Compose already installed'
        fi
      "

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
create_project_directory:
  stage: deploy
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "ğŸ“ Creating project directory..."
    - ssh -i private_key.pem -p $VM_PORT $VM_USER@$VM_HOST "
        mkdir -p ~/tbank-supermarkets
        echo 'Project directory created'
      "

# ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ½Ğ° VM
copy_files:
  stage: deploy
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
    - setup_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "ğŸ“¤ Copying files to VM..."
    - scp -i private_key.pem -P $VM_PORT -r . $VM_USER@$VM_HOST:~/tbank-supermarkets/
    - echo "âœ… Files copied successfully"

# ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
stop_existing_containers:
  stage: deploy
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "ğŸ›‘ Stopping existing containers..."
    - ssh -i private_key.pem -p $VM_PORT $VM_USER@$VM_HOST "
        cd ~/tbank-supermarkets
        docker-compose -f deploy-production.yml down || true
        echo 'Existing containers stopped'
      "

# Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
build_and_deploy:
  stage: deploy
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "ğŸ”¨ Building and deploying application..."
    - ssh -i private_key.pem -p $VM_PORT $VM_USER@$VM_HOST "
        cd ~/tbank-supermarkets
        echo 'Building Docker image...'
        docker-compose -f deploy-production.yml build --no-cache
        echo 'Starting containers...'
        docker-compose -f deploy-production.yml up -d
        echo 'Application deployed'
      "

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
check_deployment_status:
  stage: verify
  image: alpine:latest
  dependencies:
    - setup_ssh_ssl
  before_script:
    - apk add --no-cache openssh-client
    - cp ~/.ssh/private_key.pem ./private_key.pem
    - chmod 600 private_key.pem
  script:
    - echo "âœ… Checking deployment status..."
    - ssh -i private_key.pem -p $VM_PORT $VM_USER@$VM_HOST "
        cd ~/tbank-supermarkets
        echo '=== Docker Compose Status ==='
        docker-compose -f deploy-production.yml ps
        echo ''
        echo '=== Container Status ==='
        docker ps --filter name=tbank-supermarkets
        echo ''
        echo '=== Resource Usage ==='
        docker stats --no-stream --format 'table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}' tbank-supermarkets-production
      "

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° HTTP Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
test_http_accessibility:
  stage: verify
  image: alpine:latest
  script:
    - echo "ğŸŒ Testing HTTP accessibility..."
    - sleep 15
    - curl -I http://$DOMAIN || echo "HTTP not accessible yet"
    - echo "âœ… HTTP test completed"

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° HTTPS Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
test_https_accessibility:
  stage: verify
  image: alpine:latest
  script:
    - echo "ğŸ”’ Testing HTTPS accessibility..."
    - curl -I https://$DOMAIN || echo "HTTPS not accessible yet"
    - echo "âœ… HTTPS test completed"

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
verify_ssl_certificate:
  stage: verify
  image: alpine:latest
  before_script:
    - apk add --no-cache openssl
  script:
    - echo "ğŸ” Verifying SSL certificate..."
    - echo | openssl s_client -connect $DOMAIN:443 -servername $DOMAIN 2>/dev/null | openssl x509 -noout -dates || echo "SSL certificate verification failed"
    - echo "âœ… SSL certificate verification completed"

# Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
deployment_summary:
  stage: verify
  image: alpine:latest
  script:
    - echo "ğŸ‰ Hackathon deployment completed!"
    - echo ""
    - echo "ğŸŒ Application URLs:"
    - echo "   HTTP:  http://$DOMAIN"
    - echo "   HTTPS: https://$DOMAIN"
    - echo ""
    - echo "ğŸ† Ready for hackathon!"
    - echo "   Domain: $DOMAIN"
    - echo "   SSL: Configured"
    - echo "   Ports: 80 (HTTP), 443 (HTTPS)"
  when: always
