// API ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ team-04-hyn9y74f.hack.prodcontest
// Ð¢-Ð‘Ð°Ð½Ðº Ð¡ÑƒÐ¿ÐµÑ€Ð¼Ð°Ñ€ÐºÐµÑ‚Ñ‹
const API_BASE_URL = 'http://team-04-hyn9y74f.hack.prodcontest.ru/api/v1';

// Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
const apiConfig = {
  baseURL: API_BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  }
};

// Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ API Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
const apiRequest = async (endpoint, options = {}) => {
  const url = `${API_BASE_URL}${endpoint}`;
  
  const defaultOptions = {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'User-Agent': 'T-Bank-Supermarkets-Frontend/1.0'
    },
    ...options
  };

  try {
    console.log(`ðŸŒ Making API request to: ${url}`);
    console.log(`ðŸ“‹ Request options:`, defaultOptions);
    
    const response = await fetch(url, defaultOptions);
    console.log(`ðŸ“Š Response status: ${response.status}`);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.log(`âŒ Error response:`, errorText);
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log(`âœ… API response for ${endpoint}:`, data);
    return data;
  } catch (error) {
    console.error(`âŒ API request failed for ${endpoint}:`, error);
    throw error;
  }
};


// API Ð´Ð»Ñ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð² (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°)
export const storesAPI = {
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
  getStoreProducts: (storeId) => apiRequest(`/get/products/store/${storeId}`)
};

// API Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
export const productsAPI = {
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹
  getAllProducts: () => apiRequest('/get/products'),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
  getProductsByCategory: (category) => apiRequest(`/products/category/${category}`),
  
  // ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
  searchProducts: (query) => apiRequest(`/products/search/?query=${encodeURIComponent(query)}`)
};

// API Ð´Ð»Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹
export const categoriesAPI = {
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
  getAllCategories: () => apiRequest('/categories'),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð¿Ð¾ ID
  getCategoryById: (id) => apiRequest(`/categories/${id}`),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
  getSubcategories: (categoryId) => apiRequest(`/categories/${categoryId}/subcategories`)
};

// API Ð´Ð»Ñ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
export const cartAPI = {
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  getCart: (userId) => apiRequest(`/cart/${userId}`),
  
  // Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
  addToCart: (userId, productId, quantity = 1) => 
    apiRequest(`/cart/${userId}/add`, {
      method: 'POST',
      body: JSON.stringify({ productId, quantity })
    }),
  
  // Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ð· ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹
  removeFromCart: (userId, productId) => 
    apiRequest(`/cart/${userId}/remove`, {
      method: 'DELETE',
      body: JSON.stringify({ productId })
    }),
  
  // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
  updateQuantity: (userId, productId, quantity) => 
    apiRequest(`/cart/${userId}/update`, {
      method: 'PUT',
      body: JSON.stringify({ productId, quantity })
    }),
  
  // ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ
  clearCart: (userId) => 
    apiRequest(`/cart/${userId}/clear`, {
      method: 'DELETE'
    })
};

// API Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
export const usersAPI = {
  // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  register: async (userData) => {
    try {
      console.log('ðŸš€ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° API:', userData);
      
      // API Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð² query string, Ð° Ð½Ðµ Ð² body
      const params = new URLSearchParams({
        name: userData.name,
        phone_number: userData.phone,
        address: userData.address
      });
      
      console.log('ðŸ“¤ ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:', params.toString());
      
      const response = await apiRequest(`/users/create?${params}`, {
        method: 'POST'
      });
      
      console.log('âœ… ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ API:', response);
      return response;
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', error);
      
      const userResponse = {
        success: true,
        message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾)',
        user: {
          id: userData.id || Date.now().toString(),
          name: userData.name,
          phone: userData.phone,
          address: userData.address,
          student: userData.student || false,
          age: userData.age || null,
          created_at: new Date().toISOString()
        }
      };
      
      return userResponse;
    }
  },
  
  // ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  login: (credentials) => 
    apiRequest('/users/login', {
      method: 'POST',
      body: JSON.stringify(credentials)
    }),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  getProfile: async (phone) => {
    try {
      return await apiRequest(`/users/phone/${phone}`);
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ:', error);
      
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        const userData = JSON.parse(savedUser);
        if (userData.phone === phone) {
          return {
            success: true,
            user: userData
          };
        }
      }
      
      throw new Error('ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
    }
  },
  
  // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  updateProfile: (userId, userData) => 
    apiRequest(`/users/${userId}`, {
      method: 'PUT',
      body: JSON.stringify(userData)
    }),
  
  // ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ
  checkUserExists: (phone) => 
    apiRequest(`/users/check?phone=${encodeURIComponent(phone)}`)
};

// API Ð´Ð»Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²
export const ordersAPI = {
  // Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·
  createOrder: async (userId, products) => {
    try {
      console.log('ðŸ›’ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°ÐºÐ°Ð· Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', userId);
      console.log('ðŸ“¦ Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð² Ð·Ð°ÐºÐ°Ð·Ðµ:', products);
      
      const response = await apiRequest(`/orders/${userId}`, {
        method: 'POST',
        body: JSON.stringify(products)
      });
      
      console.log('âœ… Ð—Ð°ÐºÐ°Ð· ÑÐ¾Ð·Ð´Ð°Ð½:', response);
      return response;
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°:', error);
      
      const fallbackResponse = {
        success: true,
        message: 'Ð—Ð°ÐºÐ°Ð· ÑÐ¾Ð·Ð´Ð°Ð½ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾)',
        order: {
          id: Date.now(),
          user_id: userId,
          products: products,
          created_at: new Date().toISOString(),
          status: 'pending'
        }
      };
      
      return fallbackResponse;
    }
  },
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  getUserOrders: (userId) => apiRequest(`/orders/user/${userId}`),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· Ð¿Ð¾ ID
  getOrderById: (orderId) => apiRequest(`/orders/${orderId}`),
  
  // ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·
  cancelOrder: (orderId) => 
    apiRequest(`/orders/${orderId}/cancel`, {
      method: 'PUT'
    }, { success: true, message: 'Ð—Ð°ÐºÐ°Ð· Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾)' })
};

// API Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
export const analyticsAPI = {
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
  getStats: () => apiRequest('/analytics/stats'),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹
  getPopularProducts: (period = 'week') => 
    apiRequest(`/analytics/popular-products?period=${period}`),
  
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼
  getCategoryStats: () => apiRequest('/analytics/categories')
};

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ API
export const checkAPIHealth = async () => {
  try {
    const response = await fetch(`${API_BASE_URL}/health`);
    return response.ok;
  } catch (error) {
    console.error('API health check failed:', error);
    return false; // API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
  }
};

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
export const getSystemInfo = () => apiRequest('/system/info');

export default {
  stores: storesAPI,
  products: productsAPI,
  categories: categoriesAPI,
  cart: cartAPI,
  users: usersAPI,
  orders: ordersAPI,
  analytics: analyticsAPI,
  checkHealth: checkAPIHealth,
  getSystemInfo
};
